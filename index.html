<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>居酒屋注文システム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'MS Gothic', 'Hiragino Kaku Gothic Pro', monospace;
            background: #E5E5E5;
            min-height: 100vh;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .slip-container {
            width: 100%;
            max-width: 400px;
            background: #F5F5DC;
            border: 2px solid #999;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
        }

        .table-section {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-section label {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .table-section select {
            width: 120px;
            padding: 6px;
            border: 1px solid #999;
            font-size: 14px;
            background: white;
        }

        .order-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            background: #F8F8F0;
        }

        .order-table td {
            border-bottom: 1px solid #999;
            border-right: 1px solid #999;
            padding: 12px 10px;
            font-size: 16px;
            font-family: 'MS Gothic', monospace;
            height: 50px;
            vertical-align: middle;
            position: relative;
        }

        .order-table td:last-child {
            border-right: none;
        }

        .col-name {
            width: 50%;
            cursor: text;
            position: relative;
        }

        .col-qty {
            width: 20%;
            text-align: center;
            cursor: text;
        }

        .col-price {
            width: 30%;
            text-align: right;
        }

        .editable-cell {
            background: transparent;
            border: none;
            width: 100%;
            height: 100%;
            font-size: 16px;
            font-family: 'MS Gothic', monospace;
            outline: none;
            padding: 0;
            text-align: inherit;
        }

        .editable-cell.name-input {
            text-align: left;
        }

        .editable-cell.qty-input {
            text-align: center;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #999;
            max-height: 120px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: none;
        }

        .suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }

        .suggestion-item:hover {
            background: #f0f0f0;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .total-section {
            text-align: right;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .order-history {
            margin: 15px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }

        .history-header {
            background: #f0f0f0;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 14px;
            border-bottom: 1px solid #ddd;
        }

        .history-content {
            padding: 10px;
        }

        .history-order {
            margin-bottom: 10px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            font-size: 12px;
        }

        .history-order-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: #8B4513;
        }

        .history-item {
            margin: 2px 0;
            color: #666;
        }

        .confirm-section {
            text-align: center;
            margin-top: 20px;
        }

        .confirm-btn {
            background: #8B4513;
            color: white;
            border: 2px solid #8B4513;
            padding: 12px 40px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 4px;
        }

        .confirm-btn:hover {
            background: #A0522D;
            border-color: #A0522D;
        }

        .edit-btn, .cancel-btn {
            background: #666;
            color: white;
            border: 2px solid #666;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            margin-left: 10px;
        }

        .edit-btn:hover, .cancel-btn:hover {
            background: #555;
            border-color: #555;
        }

        .cancelled-item {
            text-decoration: line-through;
            color: #999;
        }

        .cancel-link {
            font-size: 10px;
            color: #d32f2f;
            text-decoration: underline;
            cursor: pointer;
            margin-left: 5px;
        }

        .disabled-input {
            background: #f5f5f5 !important;
            color: #666;
        }

        .confirmed-table {
            background-color: #F0F0F0 !important;
        }

        .confirmed-input {
            background: #F0F0F0 !important;
            color: #666 !important;
        }
    </style>
</head>
<body>
    <div class="slip-container">
        <div class="table-section">
            <label>テーブル:</label>
            <select id="table-select">
                <option value="">選択</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
            </select>
        </div>

        <table class="order-table">
            <tbody id="order-tbody">
                <tr>
                    <td class="col-name">
                        <input type="text" class="editable-cell name-input" placeholder="" data-row="0">
                        <div class="suggestions" id="suggestions-0"></div>
                    </td>
                    <td class="col-qty">
                        <input type="text" class="editable-cell qty-input" placeholder="" data-row="0">
                    </td>
                    <td class="col-price" id="price-0"></td>
                </tr>
                <tr>
                    <td class="col-name">
                        <input type="text" class="editable-cell name-input" placeholder="" data-row="1">
                        <div class="suggestions" id="suggestions-1"></div>
                    </td>
                    <td class="col-qty">
                        <input type="text" class="editable-cell qty-input" placeholder="" data-row="1">
                    </td>
                    <td class="col-price" id="price-1"></td>
                </tr>
                <tr>
                    <td class="col-name">
                        <input type="text" class="editable-cell name-input" placeholder="" data-row="2">
                        <div class="suggestions" id="suggestions-2"></div>
                    </td>
                    <td class="col-qty">
                        <input type="text" class="editable-cell qty-input" placeholder="" data-row="2">
                    </td>
                    <td class="col-price" id="price-2"></td>
                </tr>
                <tr>
                    <td class="col-name">
                        <input type="text" class="editable-cell name-input" placeholder="" data-row="3">
                        <div class="suggestions" id="suggestions-3"></div>
                    </td>
                    <td class="col-qty">
                        <input type="text" class="editable-cell qty-input" placeholder="" data-row="3">
                    </td>
                    <td class="col-price" id="price-3"></td>
                </tr>
                <tr>
                    <td class="col-name">
                        <input type="text" class="editable-cell name-input" placeholder="" data-row="4">
                        <div class="suggestions" id="suggestions-4"></div>
                    </td>
                    <td class="col-qty">
                        <input type="text" class="editable-cell qty-input" placeholder="" data-row="4">
                    </td>
                    <td class="col-price" id="price-4"></td>
                </tr>
                <tr>
                    <td class="col-name">
                        <input type="text" class="editable-cell name-input" placeholder="" data-row="5">
                        <div class="suggestions" id="suggestions-5"></div>
                    </td>
                    <td class="col-qty">
                        <input type="text" class="editable-cell qty-input" placeholder="" data-row="5">
                    </td>
                    <td class="col-price" id="price-5"></td>
                </tr>
                <tr>
                    <td class="col-name">
                        <input type="text" class="editable-cell name-input" placeholder="" data-row="6">
                        <div class="suggestions" id="suggestions-6"></div>
                    </td>
                    <td class="col-qty">
                        <input type="text" class="editable-cell qty-input" placeholder="" data-row="6">
                    </td>
                    <td class="col-price" id="price-6"></td>
                </tr>
                <tr>
                    <td class="col-name">
                        <input type="text" class="editable-cell name-input" placeholder="" data-row="7">
                        <div class="suggestions" id="suggestions-7"></div>
                    </td>
                    <td class="col-qty">
                        <input type="text" class="editable-cell qty-input" placeholder="" data-row="7">
                    </td>
                    <td class="col-price" id="price-7"></td>
                </tr>
            </tbody>
        </table>

        <div class="total-section">
            合計　<span id="total-amount">0</span>円
        </div>

        <div class="order-history" id="order-history" style="display: none;">
            <div class="history-header">注文履歴</div>
            <div class="history-content" id="history-content"></div>
        </div>

        <div class="confirm-section">
            <button class="confirm-btn" id="confirm-order">注文</button>
        </div>
    </div>

    <script>
        const menuData = [
            { name: "ビールアサヒ", price: 600, kana: "びーるあさひ" },
            { name: "キリンビール", price: 600, kana: "きりんびーる" },
            { name: "生ビール", price: 500, kana: "なまびーる" },
            { name: "ハイボール", price: 550, kana: "はいぼーる" },
            { name: "焼酎ハイ", price: 500, kana: "しょうちゅうはい" },
            { name: "日本酒", price: 700, kana: "にほんしゅ" },
            { name: "ワイン赤", price: 800, kana: "わいんあか" },
            { name: "ワイン白", price: 800, kana: "わいんしろ" },
            { name: "豚角煮", price: 1200, kana: "ぶたかくに" },
            { name: "三元豚の天ぷら", price: 900, kana: "さんげんぶたのてんぷら" },
            { name: "豚しょうが焼き", price: 850, kana: "ぶたしょうがやき" },
            { name: "牛すじ煮込み", price: 950, kana: "ぎゅうすじにこみ" },
            { name: "鶏の唐揚げ", price: 700, kana: "とりのからあげ" },
            { name: "枝豆", price: 400, kana: "えだまめ" },
            { name: "エイヒレ", price: 600, kana: "えいひれ" },
            { name: "えのきバター", price: 500, kana: "えのきばたー" },
            { name: "エリンギバター炒め", price: 550, kana: "えりんぎばたーいため" },
            { name: "えびしんじょう", price: 700, kana: "えびしんじょう" },
            { name: "しゅうまい", price: 600, kana: "しゅうまい" },
            { name: "しらす和え", price: 650, kana: "しらすあえ" },
            { name: "しゅんの魚", price: 1200, kana: "しゅんのさかな" },
            { name: "刺身盛り合わせ", price: 1500, kana: "さしみもりあわせ" },
            { name: "マグロ刺身", price: 1000, kana: "まぐろさしみ" },
            { name: "サーモン刺身", price: 900, kana: "さーもんさしみ" },
            { name: "やきとり", price: 200, kana: "やきとり" },
            { name: "焼き魚", price: 900, kana: "やきざかな" },
            { name: "サラダ", price: 500, kana: "さらだ" },
            { name: "冷奴", price: 400, kana: "ひややっこ" },
            { name: "タコの天ぷら", price: 1000, kana: "たこのてんぷら" },
            { name: "いかの塩辛", price: 550, kana: "いかのしおから" }
        ];

        let selectedItems = new Array(8).fill(null);
        let orderStatus = 'new';
        let confirmedOrders = [];
        let currentOrderData = null;

        function loadOrderHistory() {
            const saved = localStorage.getItem('orderHistory');
            return saved ? JSON.parse(saved) : [];
        }

        function saveOrderHistory(orderData) {
            const history = loadOrderHistory();
            history.push({
                ...orderData,
                timestamp: new Date().toISOString(),
                id: Date.now()
            });
            localStorage.setItem('orderHistory', JSON.stringify(history));
            displayOrderHistory();
        }

        function displayOrderHistory() {
            const historyArea = document.getElementById('order-history');
            const historyContent = document.getElementById('history-content');
            const history = loadOrderHistory();
            
            if (history.length === 0) {
                historyArea.style.display = 'none';
                return;
            }
            
            historyArea.style.display = 'block';
            historyContent.innerHTML = '';
            
            const recentHistory = history.slice(-3).reverse();
            
            recentHistory.forEach((order, index) => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'history-order';
                
                const date = new Date(order.timestamp);
                const timeStr = date.toLocaleTimeString('ja-JP', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                let itemsHtml = '';
                order.orders.forEach(item => {
                    if (!item.cancelled) {
                        itemsHtml += `<div class="history-item">${item.name} × ${item.quantity}</div>`;
                    }
                });
                
                orderDiv.innerHTML = `
                    <div class="history-order-header">
                        ${timeStr} - テーブル${order.tableNumber} - ${order.totalAmount}円
                    </div>
                    ${itemsHtml}
                `;
                
                historyContent.appendChild(orderDiv);
            });
        }

        // 履歴クリア機能
        function clearOrderHistory() {
            localStorage.removeItem('orderHistory');
            displayOrderHistory();
            console.log('注文履歴をクリアしました');
        }

        function updateOrderStatus(newStatus) {
            orderStatus = newStatus;
            updateButtonsUI();
            updateTableUI();
        }

        function updateButtonsUI() {
            const confirmSection = document.querySelector('.confirm-section');
            
            if (orderStatus === 'new') {
                confirmSection.innerHTML = `
                    <button class="confirm-btn" id="confirm-order">注文</button>
                `;
            } else if (orderStatus === 'confirmed') {
                confirmSection.innerHTML = `
                    <button class="confirm-btn" id="reorder-btn">再注文</button>
                    <button class="edit-btn" id="edit-btn">変更・取消</button>
                `;
            } else if (orderStatus === 'editing') {
                confirmSection.innerHTML = `
                    <button class="confirm-btn" id="save-changes">変更保存</button>
                    <button class="edit-btn" id="edit-btn">変更・取消</button>
                `;
            }
            
            setupButtonEventListeners();
        }

        function updateTableUI() {
            const tableElement = document.querySelector('.order-table');
            
            if (orderStatus === 'confirmed') {
                tableElement.classList.add('confirmed-table');
                document.querySelectorAll('.editable-cell').forEach(input => {
                    input.disabled = true;
                    input.classList.add('confirmed-input');
                });
            } else {
                tableElement.classList.remove('confirmed-table');
                document.querySelectorAll('.editable-cell').forEach(input => {
                    input.disabled = false;
                    input.classList.remove('confirmed-input');
                });
            }
        }

        document.querySelectorAll('.name-input').forEach((input, index) => {
            input.addEventListener('input', function() {
                handleNameInput(this, index);
            });

            input.addEventListener('focus', function() {
                this.style.backgroundColor = '#fff';
            });

            input.addEventListener('blur', function() {
                this.style.backgroundColor = '';
                setTimeout(() => {
                    hideSuggestions(index);
                }, 150);
            });
        });

        document.querySelectorAll('.qty-input').forEach((input, index) => {
            input.addEventListener('input', function() {
                let value = this.value.replace(/[０-９]/g, function(s) {
                    return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
                });
                value = value.replace(/[^0-9]/g, '');
                this.value = value;
                updateRowPrice(index);
            });

            input.addEventListener('focus', function() {
                this.style.backgroundColor = '#fff';
            });

            input.addEventListener('blur', function() {
                this.style.backgroundColor = '';
            });
        });

        function hideSuggestions(rowIndex) {
            const suggestionsDiv = document.getElementById(`suggestions-${rowIndex}`);
            if (suggestionsDiv) {
                suggestionsDiv.classList.remove('show');
            }
        }

        function showSuggestions(rowIndex) {
            const suggestionsDiv = document.getElementById(`suggestions-${rowIndex}`);
            if (suggestionsDiv) {
                suggestionsDiv.classList.add('show');
            }
        }

        function displaySuggestions(items, rowIndex) {
            const suggestionsDiv = document.getElementById(`suggestions-${rowIndex}`);
            if (!suggestionsDiv) return;
            
            suggestionsDiv.innerHTML = '';
            
            items.forEach(item => {
                const suggestionElement = document.createElement('div');
                suggestionElement.className = 'suggestion-item';
                suggestionElement.innerHTML = `
                    <span>${item.name}</span>
                    <span>¥${item.price}</span>
                `;
                
                suggestionElement.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    selectMenuItem(item, rowIndex);
                });
                
                suggestionsDiv.appendChild(suggestionElement);
            });
        }

        function selectMenuItem(item, rowIndex) {
            const nameInput = document.querySelector(`.name-input[data-row="${rowIndex}"]`);
            const qtyInput = document.querySelector(`.qty-input[data-row="${rowIndex}"]`);
            
            if (!nameInput || !qtyInput) return;
            
            nameInput.value = item.name;
            selectedItems[rowIndex] = item;
            
            hideSuggestions(rowIndex);
            updateRowPrice(rowIndex);
            
            qtyInput.focus();
        }

        function handleNameInput(input, rowIndex) {
            const query = input.value.toLowerCase().trim();

            if (query.length === 0) {
                hideSuggestions(rowIndex);
                selectedItems[rowIndex] = null;
                updateRowPrice(rowIndex);
                return;
            }

            const filteredItems = menuData.filter(item => 
                item.kana.includes(query) || item.name.toLowerCase().includes(query)
            );

            if (filteredItems.length > 0) {
                displaySuggestions(filteredItems, rowIndex);
                showSuggestions(rowIndex);
            } else {
                hideSuggestions(rowIndex);
                selectedItems[rowIndex] = null;
                updateRowPrice(rowIndex);
            }
        }

        function updateRowPrice(rowIndex) {
            const qtyInput = document.querySelector(`.qty-input[data-row="${rowIndex}"]`);
            const priceCell = document.getElementById(`price-${rowIndex}`);
            
            if (selectedItems[rowIndex] && qtyInput.value && !isNaN(qtyInput.value) && qtyInput.value > 0) {
                const total = selectedItems[rowIndex].price * parseInt(qtyInput.value);
                priceCell.textContent = total.toLocaleString();
            } else {
                priceCell.textContent = '';
            }
            
            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            for (let i = 0; i < 8; i++) {
                const qtyInput = document.querySelector(`.qty-input[data-row="${i}"]`);
                const priceCell = document.getElementById(`price-${i}`);
                
                if (selectedItems[i] && qtyInput.value && !isNaN(qtyInput.value) && qtyInput.value > 0 && !priceCell.classList.contains('cancelled-item')) {
                    total += selectedItems[i].price * parseInt(qtyInput.value);
                }
            }
            document.getElementById('total-amount').textContent = total.toLocaleString();
        }

        function setupButtonEventListeners() {
            const confirmBtn = document.getElementById('confirm-order');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', handleOrderConfirm);
            }
            
            const reorderBtn = document.getElementById('reorder-btn');
            if (reorderBtn) {
                reorderBtn.addEventListener('click', handleReorder);
            }
            
            const editBtn = document.getElementById('edit-btn');
            if (editBtn) {
                editBtn.addEventListener('click', handleEdit);
            }
            
            const saveBtn = document.getElementById('save-changes');
            if (saveBtn) {
                saveBtn.addEventListener('click', handleSaveChanges);
            }
        }

        function handleOrderConfirm() {
            const tableNumber = document.getElementById('table-select').value;
            if (!tableNumber) {
                alert('テーブル番号を選択してください');
                return;
            }

            const orders = [];
            for (let i = 0; i < 8; i++) {
                const qtyInput = document.querySelector(`.qty-input[data-row="${i}"]`);
                if (selectedItems[i] && qtyInput.value) {
                    orders.push({
                        name: selectedItems[i].name,
                        quantity: parseInt(qtyInput.value),
                        price: selectedItems[i].price,
                        cancelled: false
                    });
                }
            }

            if (orders.length === 0) {
                alert('注文商品を入力してください');
                return;
            }

            currentOrderData = {
                tableNumber: tableNumber,
                orders: orders,
                totalAmount: document.getElementById('total-amount').textContent
            };
            
            saveOrderHistory(currentOrderData);
            updateOrderStatus('confirmed');
            
            console.log(`テーブル${tableNumber}の注文を確定しました！\n合計: ${currentOrderData.totalAmount}円`);
        }

        function handleReorder() {
            // 選択アイテムをクリア
            selectedItems = new Array(8).fill(null);
            
            // 入力フィールドをクリア・有効化
            document.querySelectorAll('.name-input').forEach(input => {
                input.value = '';
                input.disabled = false;
                // 取り消し線とスタイルをクリア
                input.style.textDecoration = '';
                input.style.color = '';
            });
            
            document.querySelectorAll('.qty-input').forEach(input => {
                input.value = '';
                input.disabled = false;
                // 取り消し線とスタイルをクリア
                input.style.textDecoration = '';
                input.style.color = '';
            });
            
            // 価格セルをクリア
            document.querySelectorAll('[id^="price-"]').forEach(cell => {
                cell.textContent = '';
                // 取り消し線とスタイルをクリア
                cell.style.textDecoration = '';
                cell.style.color = '';
                // 取消リンクも削除
                const cancelLink = cell.querySelector('.cancel-link');
                if (cancelLink) {
                    cancelLink.remove();
                }
            });
            
            // 合計をリセット
            updateTotal();
            
            // 注文データをクリア
            currentOrderData = null;
            
            // 新規注文状態に戻す
            updateOrderStatus('new');
        }

        function handleEdit() {
            updateOrderStatus('editing');
            showCancelLinks();
        }

        function showCancelLinks() {
            if (!currentOrderData) return;
            
            currentOrderData.orders.forEach((order, index) => {
                const priceCell = document.getElementById(`price-${index}`);
                if (priceCell && priceCell.textContent && !order.cancelled) {
                    priceCell.innerHTML += `<span class="cancel-link" onclick="cancelOrderItem(${index})">取消</span>`;
                }
            });
        }

        function cancelOrderItem(index) {
            if (currentOrderData && currentOrderData.orders[index]) {
                currentOrderData.orders[index].cancelled = true;
                
                const nameInput = document.querySelector(`.name-input[data-row="${index}"]`);
                const qtyInput = document.querySelector(`.qty-input[data-row="${index}"]`);
                const priceCell = document.getElementById(`price-${index}`);
                
                nameInput.style.textDecoration = 'line-through';
                nameInput.style.color = '#999';
                qtyInput.style.textDecoration = 'line-through';
                qtyInput.style.color = '#999';
                priceCell.style.textDecoration = 'line-through';
                priceCell.style.color = '#999';
                
                const cancelLink = priceCell.querySelector('.cancel-link');
                if (cancelLink) {
                    cancelLink.remove();
                }
                
                updateTotal();
            }
        }

        function handleSaveChanges() {
            // 取消リンクを削除
            document.querySelectorAll('.cancel-link').forEach(link => link.remove());
            
            if (currentOrderData) {
                saveOrderHistory(currentOrderData);
            }
            updateOrderStatus('confirmed');
            console.log('変更を保存しました');
        }

        function initializeApp() {
            setupButtonEventListeners();
            setupTableChangeListener(); // テーブル変更監視を追加
            updateOrderStatus('new');
            displayOrderHistory();
        }

        // テーブル選択変更の監視
        function setupTableChangeListener() {
            const tableSelect = document.getElementById('table-select');
            let previousTable = tableSelect.value;
            
            tableSelect.addEventListener('change', function() {
                const currentTable = this.value;
                
                // テーブルが変更された場合（空から選択も含む）
                if (currentTable !== previousTable && currentTable !== '') {
                    clearOrderHistory();
                    console.log(`テーブル${currentTable}に変更しました。履歴をクリアしました。`);
                }
                
                previousTable = currentTable;
            });
        }

        document.addEventListener('click', function(e) {
            document.querySelectorAll('.suggestions').forEach((suggestion, index) => {
                if (!suggestion.parentElement.contains(e.target)) {
                    hideSuggestions(index);
                }
            });
        });

        window.cancelOrderItem = cancelOrderItem;

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
