<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>居酒屋注文システム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'MS Gothic', 'Hiragino Kaku Gothic Pro', monospace;
            background: #E5E5E5;
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .slip-container {
            width: 100%;
            max-width: 360px;
            background: #F5F5DC;
            border: 2px solid #999;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
            height: fit-content;
        }

        .table-section {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-section label {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .table-section select {
            width: 120px;
            padding: 6px;
            border: 1px solid #999;
            font-size: 14px;
            background: white;
        }

        .table-container {
            border: 1px solid #999;
            border-left: none;
            border-right: none;
            border-radius: 4px;
        }

        .order-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
            background: #F8F8F0;
        }

        .order-table td {
            border-bottom: 1px solid #999;
            border-right: 1px solid #999;
            padding: 8px 6px;
            font-size: 14px;
            font-family: 'MS Gothic', monospace;
            height: 45px;
            vertical-align: middle;
            position: relative;
        }

        .order-table td:last-child {
            border-right: none;
        }

        .order-table tr:last-child td {
            border-bottom: none;
        }

        .col-name {
            width: 50%;
            cursor: text;
            position: relative;
        }

        .col-qty {
            width: 20%;
            text-align: center;
            cursor: text;
        }

        .col-price {
            width: 30%;
            text-align: center;
            cursor: text;
            border-right: none !important;
        }

        .col-total {
            display: none;
        }

        .editable-cell {
            background: transparent;
            border: none;
            width: 100%;
            height: 100%;
            font-size: 14px;
            font-family: 'MS Gothic', monospace;
            outline: none;
            padding: 0;
            text-align: inherit;
        }

        .editable-cell.name-input {
            text-align: left;
        }

        .editable-cell.qty-input {
            text-align: center;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #999;
            max-height: 120px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: none;
        }

        .suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }

        .suggestion-item:hover {
            background: #f0f0f0;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .total-section {
            text-align: right;
            margin: 10px 0 15px 0;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .confirm-section {
            text-align: center;
            margin-top: 15px;
            margin-bottom: 20px;
        }

        .confirm-btn {
            background: #8B4513;
            color: white;
            border: 2px solid #8B4513;
            padding: 12px 40px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            width: 100%;
            max-width: 200px;
        }

        .confirm-btn:hover {
            background: #A0522D;
            border-color: #A0522D;
        }

        .edit-btn, .cancel-btn {
            background: #666;
            color: white;
            border: 2px solid #666;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            margin-left: 10px;
        }

        .edit-btn:hover, .cancel-btn:hover {
            background: #555;
            border-color: #555;
        }

        /* 注文履歴セクション */
        .order-history-section {
            margin-top: 20px;
            border-top: 2px solid #999;
            padding-top: 15px;
        }

        .history-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .history-item {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 11px;
            color: #666;
        }

        .history-content {
            font-size: 12px;
        }

        .history-item-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px dotted #ddd;
        }

        .history-item-row:last-child {
            border-bottom: none;
            font-weight: bold;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #ddd;
        }

        .history-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }

        .modify-cancel-btn {
            background: #8B4513;
            color: white;
            border: 2px solid #8B4513;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
            flex: 1;
        }

        .modify-cancel-btn:hover {
            background: #A0522D;
            border-color: #A0522D;
        }

        .edit-order-btn {
            background: #4CAF50;
            color: white;
            border: 2px solid #4CAF50;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
            flex: 1;
        }

        .edit-order-btn:hover {
            background: #45a049;
            border-color: #45a049;
        }

        .cancelled-item {
            text-decoration: line-through;
            color: #999;
        }

        .modified-item {
            background-color: #fff3cd;
        }

        .status-badge {
            display: inline-block;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: bold;
        }

        .status-confirmed {
            display: none;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .status-modified {
            background: #fff3cd;
            color: #856404;
        }

        .clear-history-btn {
            display: none;
        }
    </style>
</head>
<body>
    <div class="slip-container">
        <div class="table-section">
            <label>テーブル:</label>
            <select id="table-select">
                <option value="">選択</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
            </select>
        </div>

        <div class="table-container">
            <table class="order-table">
                <tbody id="order-tbody">
                    <tr>
                        <td class="col-name">
                            <input type="text" class="editable-cell name-input" placeholder="" data-row="0">
                            <div class="suggestions" id="suggestions-0"></div>
                        </td>
                        <td class="col-qty">
                            <input type="text" class="editable-cell qty-input" placeholder="" data-row="0">
                        </td>
                        <td class="col-price">
                            <input type="text" class="editable-cell price-input" placeholder="" data-row="0">
                        </td>
                        <td class="col-total" id="total-0"></td>
                    </tr>
                    <tr>
                        <td class="col-name">
                            <input type="text" class="editable-cell name-input" placeholder="" data-row="1">
                            <div class="suggestions" id="suggestions-1"></div>
                        </td>
                        <td class="col-qty">
                            <input type="text" class="editable-cell qty-input" placeholder="" data-row="1">
                        </td>
                        <td class="col-price">
                            <input type="text" class="editable-cell price-input" placeholder="" data-row="1">
                        </td>
                        <td class="col-total" id="total-1"></td>
                    </tr>
                    <tr>
                        <td class="col-name">
                            <input type="text" class="editable-cell name-input" placeholder="" data-row="2">
                            <div class="suggestions" id="suggestions-2"></div>
                        </td>
                        <td class="col-qty">
                            <input type="text" class="editable-cell qty-input" placeholder="" data-row="2">
                        </td>
                        <td class="col-price">
                            <input type="text" class="editable-cell price-input" placeholder="" data-row="2">
                        </td>
                        <td class="col-total" id="total-2"></td>
                    </tr>
                    <tr>
                        <td class="col-name">
                            <input type="text" class="editable-cell name-input" placeholder="" data-row="3">
                            <div class="suggestions" id="suggestions-3"></div>
                        </td>
                        <td class="col-qty">
                            <input type="text" class="editable-cell qty-input" placeholder="" data-row="3">
                        </td>
                        <td class="col-price">
                            <input type="text" class="editable-cell price-input" placeholder="" data-row="3">
                        </td>
                        <td class="col-total" id="total-3"></td>
                    </tr>
                    <tr>
                        <td class="col-name">
                            <input type="text" class="editable-cell name-input" placeholder="" data-row="4">
                            <div class="suggestions" id="suggestions-4"></div>
                        </td>
                        <td class="col-qty">
                            <input type="text" class="editable-cell qty-input" placeholder="" data-row="4">
                        </td>
                        <td class="col-price">
                            <input type="text" class="editable-cell price-input" placeholder="" data-row="4">
                        </td>
                        <td class="col-total" id="total-4"></td>
                    </tr>
                    <tr>
                        <td class="col-name">
                            <input type="text" class="editable-cell name-input" placeholder="" data-row="5">
                            <div class="suggestions" id="suggestions-5"></div>
                        </td>
                        <td class="col-qty">
                            <input type="text" class="editable-cell qty-input" placeholder="" data-row="5">
                        </td>
                        <td class="col-price">
                            <input type="text" class="editable-cell price-input" placeholder="" data-row="5">
                        </td>
                        <td class="col-total" id="total-5"></td>
                    </tr>
                    <tr>
                        <td class="col-name">
                            <input type="text" class="editable-cell name-input" placeholder="" data-row="6">
                            <div class="suggestions" id="suggestions-6"></div>
                        </td>
                        <td class="col-qty">
                            <input type="text" class="editable-cell qty-input" placeholder="" data-row="6">
                        </td>
                        <td class="col-price">
                            <input type="text" class="editable-cell price-input" placeholder="" data-row="6">
                        </td>
                        <td class="col-total" id="total-6"></td>
                    </tr>
                    <tr>
                        <td class="col-name">
                            <input type="text" class="editable-cell name-input" placeholder="" data-row="7">
                            <div class="suggestions" id="suggestions-7"></div>
                        </td>
                        <td class="col-qty">
                            <input type="text" class="editable-cell qty-input" placeholder="" data-row="7">
                        </td>
                        <td class="col-price">
                            <input type="text" class="editable-cell price-input" placeholder="" data-row="7">
                        </td>
                        <td class="col-total" id="total-7"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="total-section">
            合計　<span id="total-amount">0</span>円
        </div>

        <div class="confirm-section">
            <button class="confirm-btn" id="confirm-order">注文</button>
        </div>

        <!-- 注文履歴セクション -->
        <div class="order-history-section">
            <div class="history-title">注文履歴</div>
            <div id="order-history-container">
                <!-- 注文履歴がここに表示されます -->
            </div>
        </div>
    </div>

    <script>
        const menuData = [
            { name: "ビールアサヒ", price: 600, kana: "びーるあさひ" },
            { name: "キリンビール", price: 600, kana: "きりんびーる" },
            { name: "生ビール", price: 500, kana: "なまびーる" },
            { name: "ハイボール", price: 550, kana: "はいぼーる" },
            { name: "焼酎ハイ", price: 500, kana: "しょうちゅうはい" },
            { name: "日本酒", price: 700, kana: "にほんしゅ" },
            { name: "ワイン赤", price: 800, kana: "わいんあか" },
            { name: "ワイン白", price: 800, kana: "わいんしろ" },
            { name: "豚角煮", price: 1200, kana: "ぶたかくに" },
            { name: "三元豚の天ぷら", price: 900, kana: "さんげんぶたのてんぷら" },
            { name: "豚しょうが焼き", price: 850, kana: "ぶたしょうがやき" },
            { name: "牛すじ煮込み", price: 950, kana: "ぎゅうすじにこみ" },
            { name: "鶏の唐揚げ", price: 700, kana: "とりのからあげ" },
            { name: "枝豆", price: 400, kana: "えだまめ" },
            { name: "エイヒレ", price: 600, kana: "えいひれ" },
            { name: "えのきバター", price: 500, kana: "えのきばたー" },
            { name: "エリンギバター炒め", price: 550, kana: "えりんぎばたーいため" },
            { name: "えびしんじょう", price: 700, kana: "えびしんじょう" },
            { name: "しゅうまい", price: 600, kana: "しゅうまい" },
            { name: "しらす和え", price: 650, kana: "しらすあえ" },
            { name: "しゅんの魚", price: 1200, kana: "しゅんのさかな" },
            { name: "刺身盛り合わせ", price: 1500, kana: "さしみもりあわせ" },
            { name: "マグロ刺身", price: 1000, kana: "まぐろさしみ" },
            { name: "サーモン刺身", price: 900, kana: "さーもんさしみ" },
            { name: "やきとり", price: 200, kana: "やきとり" },
            { name: "焼き魚", price: 900, kana: "やきざかな" },
            { name: "サラダ", price: 500, kana: "さらだ" },
            { name: "冷奴", price: 400, kana: "ひややっこ" },
            { name: "タコの天ぷら", price: 1000, kana: "たこのてんぷら" },
            { name: "いかの塩辛", price: 550, kana: "いかのしおから" }
        ];

        let selectedItems = new Array(8).fill(null);

        function getStorageKey() {
            const tableNumber = document.getElementById('table-select').value;
            return tableNumber ? `orderHistory_table_${tableNumber}` : 'orderHistory_default';
        }

        function loadOrderHistory() {
            const saved = localStorage.getItem(getStorageKey());
            return saved ? JSON.parse(saved) : [];
        }

        function saveOrderHistory(orderData) {
            const history = loadOrderHistory();
            history.push({
                ...orderData,
                timestamp: new Date().toISOString(),
                id: Date.now(),
                status: 'confirmed'
            });
            localStorage.setItem(getStorageKey(), JSON.stringify(history));
            displayOrderHistory();
        }

        function updateOrderHistory(orderId, updatedData) {
            const history = loadOrderHistory();
            const orderIndex = history.findIndex(order => order.id === orderId);
            if (orderIndex !== -1) {
                history[orderIndex] = { ...history[orderIndex], ...updatedData };
                localStorage.setItem(getStorageKey(), JSON.stringify(history));
                displayOrderHistory();
            }
        }

        function displayOrderHistory() {
            const container = document.getElementById('order-history-container');
            const history = loadOrderHistory();
            
            if (history.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">注文履歴がありません</div>';
                return;
            }
            
            container.innerHTML = '';
            
            history.reverse().forEach(order => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const statusClass = order.status === 'cancelled' ? 'status-cancelled' : 
                                  order.status === 'modified' ? 'status-modified' : 'status-confirmed';
                
                const statusText = order.status === 'cancelled' ? '取消済' : 
                                 order.status === 'modified' ? '変更済' : '';
                
                let itemsHtml = '';
                let totalAmount = 0;
                
                order.orders.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    if (!item.cancelled) {
                        totalAmount += itemTotal;
                    }
                    
                    const itemClass = item.cancelled ? 'cancelled-item' : '';
                    itemsHtml += `
                        <div class="history-item-row ${itemClass}">
                            <span>${item.name} × ${item.quantity}</span>
                            <span>¥${itemTotal.toLocaleString()}</span>
                        </div>
                    `;
                });
                
                itemsHtml += `
                    <div class="history-item-row">
                        <span>合計</span>
                        <span>¥${totalAmount.toLocaleString()}</span>
                    </div>
                `;
                
                historyItem.innerHTML = `
                    <div class="history-header">
                        <span>${new Date(order.timestamp).toLocaleString()}</span>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="history-content">
                        ${itemsHtml}
                    </div>
                    <div class="history-buttons">
                        <button class="edit-order-btn" onclick="editOrder(${order.id})">変更</button>
                        <button class="modify-cancel-btn" onclick="modifyOrder(${order.id})">取消</button>
                    </div>
                `;
                
                container.appendChild(historyItem);
            });
        }

        function addToCurrentOrder(orderId) {
            // この関数は削除されました
        }

        function modifyOrder(orderId) {
            const history = loadOrderHistory();
            const order = history.find(o => o.id === orderId);
            if (!order) return;
            
            if (order.status === 'cancelled') {
                alert('この注文は既に取消済みです。');
                return;
            }
            
            const action = confirm('この注文を取消しますか？\n「OK」= 全体取消\n「キャンセル」= 個別変更');
            
            if (action) {
                // 全体取消
                updateOrderHistory(orderId, { status: 'cancelled' });
                alert('注文を取消しました。');
            } else {
                // 個別変更モード
                showOrderModificationModal(orderId);
            }
        }

        function showOrderModificationModal(orderId) {
            const history = loadOrderHistory();
            const order = history.find(o => o.id === orderId);
            if (!order) return;
            
            let modalHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center;" id="modification-modal">
                    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
                        <h3 style="margin-bottom: 15px;">注文変更</h3>
                        <div id="modification-items">
            `;
            
            order.orders.forEach((item, index) => {
                if (!item.cancelled) {
                    modalHtml += `
                        <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="checkbox" id="cancel-${index}" style="margin-right: 8px;">
                            <span style="flex: 1;">${item.name} × ${item.quantity} (¥${item.price})</span>
                        </div>
                    `;
                }
            });
            
            modalHtml += `
                        </div>
                        <div style="margin-top: 20px; text-align: right;">
                            <button onclick="closeModificationModal()" style="margin-right: 10px; padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px;">キャンセル</button>
                            <button onclick="applyModifications(${orderId})" style="padding: 8px 16px; background: #8B4513; color: white; border: none; border-radius: 4px;">取消</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeModificationModal() {
            const modal = document.getElementById('modification-modal');
            if (modal) {
                modal.remove();
            }
        }

        function applyModifications(orderId) {
            const history = loadOrderHistory();
            const order = history.find(o => o.id === orderId);
            if (!order) return;
            
            let hasChanges = false;
            order.orders.forEach((item, index) => {
                const checkbox = document.getElementById(`cancel-${index}`);
                if (checkbox && checkbox.checked) {
                    item.cancelled = true;
                    hasChanges = true;
                }
            });
            
            if (hasChanges) {
                updateOrderHistory(orderId, { status: 'modified', orders: order.orders });
                alert('選択した商品を取消しました。');
            }
            
            closeModificationModal();
        }

        // 既存の関数群
        document.querySelectorAll('.name-input').forEach((input, index) => {
            input.addEventListener('input', function() {
                handleNameInput(this, index);
            });

            input.addEventListener('focus', function() {
                this.style.backgroundColor = '#fff';
            });

            input.addEventListener('blur', function() {
                this.style.backgroundColor = '';
                setTimeout(() => {
                    hideSuggestions(index);
                }, 150);
            });
        });

        document.querySelectorAll('.qty-input').forEach((input, index) => {
            input.addEventListener('input', function() {
                let value = this.value.replace(/[０-９]/g, function(s) {
                    return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
                });
                value = value.replace(/[^0-9]/g, '');
                this.value = value;
                updateRowPrice(index);
            });

            input.addEventListener('focus', function() {
                this.style.backgroundColor = '#fff';
            });

            input.addEventListener('blur', function() {
                this.style.backgroundColor = '';
            });
        });

        document.querySelectorAll('.price-input').forEach((input, index) => {
            input.addEventListener('input', function() {
                let value = this.value.replace(/[０-９]/g, function(s) {
                    return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
                });
                value = value.replace(/[^0-9]/g, '');
                this.value = value;
                updateRowPrice(index);
            });

            input.addEventListener('focus', function() {
                this.style.backgroundColor = '#fff';
            });

            input.addEventListener('blur', function() {
                this.style.backgroundColor = '';
            });
        });

        function hideSuggestions(rowIndex) {
            const suggestionsDiv = document.getElementById(`suggestions-${rowIndex}`);
            if (suggestionsDiv) {
                suggestionsDiv.classList.remove('show');
            }
        }

        function showSuggestions(rowIndex) {
            const suggestionsDiv = document.getElementById(`suggestions-${rowIndex}`);
            if (suggestionsDiv) {
                suggestionsDiv.classList.add('show');
            }
        }

        function displaySuggestions(items, rowIndex) {
            const suggestionsDiv = document.getElementById(`suggestions-${rowIndex}`);
            if (!suggestionsDiv) return;
            
            suggestionsDiv.innerHTML = '';
            
            items.forEach(item => {
                const suggestionElement = document.createElement('div');
                suggestionElement.className = 'suggestion-item';
                suggestionElement.innerHTML = `
                    <span>${item.name}</span>
                    <span>¥${item.price}</span>
                `;
                
                suggestionElement.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    selectMenuItem(item, rowIndex);
                });
                
                suggestionsDiv.appendChild(suggestionElement);
            });
        }

        function selectMenuItem(item, rowIndex) {
            const nameInput = document.querySelector(`.name-input[data-row="${rowIndex}"]`);
            const qtyInput = document.querySelector(`.qty-input[data-row="${rowIndex}"]`);
            const priceInput = document.querySelector(`.price-input[data-row="${rowIndex}"]`);
            
            if (!nameInput || !qtyInput || !priceInput) return;
            
            nameInput.value = item.name;
            priceInput.value = item.price;
            selectedItems[rowIndex] = item;
            
            hideSuggestions(rowIndex);
            updateRowPrice(rowIndex);
            
            qtyInput.focus();
        }

        function handleNameInput(input, rowIndex) {
            const query = input.value.toLowerCase().trim();

            if (query.length === 0) {
                hideSuggestions(rowIndex);
                updateRowPrice(rowIndex);
                return;
            }

            const filteredItems = menuData.filter(item => 
                item.kana.includes(query) || item.name.toLowerCase().includes(query)
            );

            if (filteredItems.length > 0) {
                displaySuggestions(filteredItems, rowIndex);
                showSuggestions(rowIndex);
            } else {
                hideSuggestions(rowIndex);
                updateRowPrice(rowIndex);
            }
        }

        function updateRowPrice(rowIndex) {
            const qtyInput = document.querySelector(`.qty-input[data-row="${rowIndex}"]`);
            const priceInput = document.querySelector(`.price-input[data-row="${rowIndex}"]`);
            const totalCell = document.getElementById(`total-${rowIndex}`);
            
            const quantity = parseInt(qtyInput.value) || 0;
            const price = parseInt(priceInput.value) || 0;
            
            if (quantity > 0 && price > 0) {
                const total = price * quantity;
                totalCell.textContent = total.toLocaleString();
            } else {
                totalCell.textContent = '';
            }
            
            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            for (let i = 0; i < 8; i++) {
                const qtyInput = document.querySelector(`.qty-input[data-row="${i}"]`);
                const priceInput = document.querySelector(`.price-input[data-row="${i}"]`);
                
                const quantity = parseInt(qtyInput.value) || 0;
                const price = parseInt(priceInput.value) || 0;
                
                if (quantity > 0 && price > 0) {
                    total += price * quantity;
                }
            }
            document.getElementById('total-amount').textContent = total.toLocaleString();
        }

        function handleOrderConfirm() {
            const tableNumber = document.getElementById('table-select').value;
            if (!tableNumber) {
                alert('テーブル番号を選択してください');
                return;
            }

            const orders = [];
            for (let i = 0; i < 8; i++) {
                const nameInput = document.querySelector(`.name-input[data-row="${i}"]`);
                const qtyInput = document.querySelector(`.qty-input[data-row="${i}"]`);
                const priceInput = document.querySelector(`.price-input[data-row="${i}"]`);
                
                const name = nameInput.value.trim();
                const quantity = parseInt(qtyInput.value) || 0;
                const price = parseInt(priceInput.value) || 0;
                
                if (name && quantity > 0 && price > 0) {
                    orders.push({
                        name: name,
                        quantity: quantity,
                        price: price,
                        cancelled: false
                    });
                }
            }

            if (orders.length === 0) {
                alert('注文商品を入力してください');
                return;
            }

            const orderData = {
                tableNumber: tableNumber,
                orders: orders,
                totalAmount: document.getElementById('total-amount').textContent
            };
            
            saveOrderHistory(orderData);
            clearCurrentOrder();
            
            alert(`テーブル${tableNumber}の注文を確定しました！\n合計: ${orderData.totalAmount}円`);
        }

        function clearCurrentOrder() {
            // 入力フィールドをクリア
            document.querySelectorAll('.name-input').forEach(input => input.value = '');
            document.querySelectorAll('.qty-input').forEach(input => input.value = '');
            document.querySelectorAll('.price-input').forEach(input => input.value = '');
            
            // 小計セルをクリア
            document.querySelectorAll('[id^="total-"]').forEach(cell => cell.textContent = '');
            
            // 合計をリセット
            updateTotal();
            
            // 選択アイテムをクリア
            selectedItems = new Array(8).fill(null);
        }

        function clearAllHistory() {
            if (confirm('すべての注文履歴を削除しますか？')) {
                localStorage.removeItem(getStorageKey());
                displayOrderHistory();
                alert('注文履歴をクリアしました。');
            }
        }

        function setupEventListeners() {
            document.getElementById('confirm-order').addEventListener('click', handleOrderConfirm);
            
            // テーブル選択変更時の処理
            document.getElementById('table-select').addEventListener('change', function() {
                displayOrderHistory();
            });
        }

        document.addEventListener('click', function(e) {
            document.querySelectorAll('.suggestions').forEach((suggestion, index) => {
                if (!suggestion.parentElement.contains(e.target)) {
                    hideSuggestions(index);
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            displayOrderHistory();
        });
    </script>
</body>
</html>
